<div align="center">
<img width="100" height="25" src="res/logo.svg" alt="Errors Logo"/>
<h3 align="center">Mondu Trade Account - WooCommerce</h3>

![GitHub Release](https://img.shields.io/github/v/release/ainsleydev/mondu-trade-woocommerce?display_name=release&style=flat&cacheSeconds=3600)
[![GNU General Public License 3.0](https://img.shields.io/github/license/ainsleyclark/squidge.svg)](https://www.gnu.org/licenses/gpl-3.0.en.html)
[![WP CS Check](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/lint.yaml/badge.svg?branch=main)](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/lint.yaml)
[![Security Check](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/security.yaml/badge.svg?branch=main)](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/security.yaml)
[![ainsley.dev](https://img.shields.io/badge/-ainsley.dev-black?style=flat&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5wEYDzUGL1b35AAABA1JREFUWMPtlttvFVUUxn977ZnZu+W0tLalqRovBAUvQag0xNQbpSIosSSIJC198YknJfHJxDf9A/DBJ0x8MbFACjVqvCASq6FYFLFBvJAaAomkFCmhHGpLO+PDzOmZzpn2nKP4pCs5ycmevb7vW99as/fA//FfD1XO5p1nzuA3NWJHx5T8cVkRBPHHQfRjd0tzyZhOOQIy27bAxET9zCuvvhY0r2kC/OiRABeAN4BL/4oDr9+3lGszPs7UVNfUE23v3Nj5koszR/8N4EXg3XJckFIFuCLUuU7GWNNtTg25cu4syJx0F+gGMuU4UJKAt1Yux1UKV6TVat1qs+OYwQESMwDQCjwKsOv4iZsnwGihwbiuEek2WjJGhMrvv0UujYKa08VFkQvuTXNgz6oVeCIo1CqrZYMRwTiaytERKn44kRQAsAFYDbBrsLgLRQU0GI919TXKiHQaUQ1GBCuCCQKqjg/MqInrM4lZrgc6A1CljHhRAZ4Ip65m77FaOmbJdehC5vzZr1RAf/T6x6NDwb3/uAVfP74GnwCjZasRuXuWXASj9XQme+3t6erqPcB0IvUuYCsUH8YFBRhRNBqvyYpsn0MeOnG6wvc/9x33MPBjSvp24Na/7cDP7Y/gKIURecZoeTBObkSwWg7UNjaOeFfGLgK9KRAPAM8Wc2FeAUaEWtddbEV2WBFtREXkCqvlghE5yOQkvucBHAR+T0BooAtYXLYDI5sewxWFJ/Kk1bI2UTlW5DMFp03+JPwJ+DQFai2wbiEXUgVUas0trmuslm4jUmGi/tuwDVmrpafBuNPVrs7N/wzQA2QTUJbwYLIlOxB0tOGJ4IhqsSJts+T54Rv0lBz1RFh9ZJA385fOAHAshaMNaAF4OcWFQgeUwhMlrlJdnqjaOLkR8Y2WvbWec9VIQeo4sJf8FZ2LmmgWJO1cmm8I7wc2a6XwosGL+v+rFfnYUYplh47Obo5dvZ8Av6TgbSZ8KxYWEGxZn/u7Dbg9t8HNnwF9S2qqzqVUn4vzQF/K+m3AC1A4jGlId0QC8l0BXKVGrahe//okNR99WZAUc6EXuJiC+zxw57wOxKp/DliRAvCFKDUkxS+YIeBwyvryCHuOC0kH6oBOCj/V/gTeA6aK0oefZj3ARGJdRdh1BQ7Eqm8HHk4B/Q7oB1B9acWFEWtDf5STjGbgqbgLcQcqCQ8NL5EUAPuBsRKqz8UVYB+F97QXcSyatSXoWJ8zvB04AFQlkoaBp4HhhaqPR1TdUsLjeVni8TjhVX0odCAkd4AdKeQAHxIwXEb1Odt+Az5IeVQVcTmhgDBWAhtTNl8G9qGAwKfU2N3SnJvi/RFGMjYCD8UFdACNKRsHgZMA6v0j5ZpAlPtNyvqSiJO/AKik60y0ALlUAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIzLTAxLTI0VDE1OjUzOjA2KzAwOjAwm5vntAAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMy0wMS0yNFQxNTo1MzowNiswMDowMOrGXwgAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII=)](https://ainsley.dev)
[![Twitter](https://img.shields.io/twitter/follow/ainsleydev)](https://twitter.com/ainsleydev)

</div>

## Overview

The Mondu Trade Account - WooCommerce plugin integrates Mondu's Digital Trade Account functionality into your
WooCommerce store, allowing your customers to apply for and manage trade accounts directly during checkout.

- ✅ **Trade Account Applications**: Let customers apply for a trade account while completing their order.
- ✅ **Webhook Integration**: Automatically update customer statuses (e.g., accepted, pending, declined) when a customer
  has applied for a Digital Trade Account.
- ✅ **Custom Styling and Actions**: Easily extend and customize the checkout experience with hooks and filters. Allowing
  you to run actions when a buyer has been accepted or declined.
- ✅ **Admin Management Tools**: Access customer trade account information, logs, and webhook settings from the WordPress
  admin panel.
- ✅ **Secure and Compliant**: Fully supports WooCommerce standards and uses secure connections for API communication.

## Installation

You can either download a the zip file from the releases section or locate it on the WordPress Plugin install page.

## Prerequisites

Before installing and using the Mondu Trade Account - WooCommerce plugin, ensure your environment meets the following
requirements:

- **WordPress**: Requires at least version `6.7`
- **PHP**: Requires at least version `7.4`
- **WooCommerce**: Requires at least version `9.4`
- **Mondu Plugin** Needs to be installed, tested version `3.0.3`

## Backwards Compatibility

This plugin has direct dependency on the `Mondu Plugin`. Before updating both plugins, always test the new version on a
staging environment to ensure compatibility with your customizations, integrations, and WooCommerce setup.

Useful Links:

- [Official GitHub Repository](https://github.com/mondu-ai/bnpl-checkout-woocommerce)
- [Changelog](https://github.com/mondu-ai/bnpl-checkout-woocommerce/blob/main/changelog.txt)

## FAQs

### Is the plugin compatible with the WP block editor?

Not at this time.

### How do I allow for signups outside the checkout?

This plugin adds native support for allowing users to sign up to a Trade Account outside of the checkout. Perfect for
CTA's or banners.

**Note**: The user must be logged in to perform this action, this is because when Mondu responds to the Trade Account
request, a customer ID is required. Before displaying the form below, ensure your users are logged in by using the
WordPress `is_user_logged_in()` function.

The only thing you need to send is a nonce, and the user details will be obtained progromatically from the WP user
that's logged in.

**Shortcode**:

If you don't fancy writing the form yourself, you can easily perform a shortcode as shown below.

```php
echo do_shortcode('[mondu_trade_account_form]');
```

**HTML**:

Alternatively, you can crate the form from scratch as shown below:

```html

<form id="trade-account-signup" method="POST" action="<?php echo admin_url('admin-ajax.php'); ?>">
  <input type="hidden" name="action" value="trade_account_submit">
  <?php wp_nonce_field('trade_account_submit', 'trade_account_submit_nonce'); ?>
  <button type="submit">Submit</button>
</form>
```

**JavaScript**:

Below shows how you can send data to the form via JS.

```js
document.querySelector('form').addEventListener('submit', function (event) {
  event.preventDefault();

  const form = event.target;
  const formData = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    body: formData,
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      return response.json();
    })
    .then((data) => {
      if (!data.error) {
        alert('Trade Account application submitted successfully.');
      } else {
        alert(`Error: ${data.message || 'An error occurred while submitting the application.'}`);
      }
    })
    .catch((error) => {
      alert(`An error occurred: ${error.message}`);
    });
});
```

**Response**:

```json
{
  "status": 200,
  "message": "Trade Account application submitted successfully.",
  "data": {
    "hosted_page_uri": "https://mondu.ai/checkout-page"
  },
  "error": false
}
```

---

### How do I know what the status is of a customer?

Simply go to the user's account on WordPress by navigating to `Users` and click on a customer. From there, you should
see the following fields:

- `uuid` -> The external UUID that's been assigned from Mondu.
- `status` -> The buyer status which can be one of `unknown`, `accepted`, pending` or `declined`.

---

### Will Mondu email the customer after a Trade Account has been applied for?

---

### How do I add custom styling to the payment gateway?

There may be times you want to style the checkout gateway with your own styles. To do this, you can either latch onto
the default class name `mondu-trade` or provide your own using a filter.

An example of this is below:

```php
add_filter('mondu_trade_account_checkout_class', function ($class) {
	return $class . ' my-class-name';
});
```

---

### How can I run actions when a buyer status has changed?

There are 4 different actions you can latch onto when Mondu replies with an update after a customer has applied for a
Digital Trade Account. Below is a list of available actions.

**Example Payload**

Below is an example of a buyer and topic sent via the actions, see
the [Mondu Webhooks Overview](https://docs.mondu.ai/reference/webhooks-overview) for more information

```json
{
  "topic": "buyer/{TOPIC_NAME}",
  "buyer": {
    "uuid": "66e8d234-23b5-1125-9592-d7390f20g01c",
    "state": "accepted",
    "external_reference_id": "DE-1-1000745773",
    "company_name": "2023-02-07T15:14:22.301Z",
    "first_name": "John",
    "last_name": "Smith"
  }
}
```

### General Webhook Action

`mondu_trade_buyer_webhook_received`

Triggered when a webhook related to a buyer is received from Mondu.

**Parameters:**

- `$state (string)`:    The current state of the buyer (e.g. `accepted`, `pending`, `declined`).
- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

**Usage**

```php
add_action('mondu_trade_buyer_webhook_received', function ($state, $customer_id, $buyer) {
   print_r([
        'state' => $state,
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
});
```

### Accepted

`mondu_trade_buyer_accepted`

Triggered when a buyer has been accepted for a Trade Account.

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

```php
add_action('mondu_trade_buyer_accepted', function ($customer_id, $buyer) {
   print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
});
```

### Pending

`mondu_trade_buyer_pending`

Triggered when a buyer is in a pending state (maximum 48 hours).

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

```php
add_action('mondu_trade_buyer_pending', function ($customer_id, $buyer) {
   print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
});
```

### Declined

`mondu_trade_buyer_declined`

Triggered when a buyer has been declined for a Trade Account.

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

```php
add_action('mondu_trade_buyer_declined', function ($customer_id, $buyer) {
   print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
});
```

---

## Screenshots

## Development

Below are the steps to install the plugin on your local machine for development.

### Setup

To get setup with plugin, follow the steps listed below.

**1. Clone the Repository**

Clone the repository into your `/wp-content/plugins` folder.

```shell
git clone https://github.com/ainsleydev/mondu-trade-woocommerce
cd mondu-trade-woocommerce
```

**2. Install Dependencies**

Ensure you have Composer and the WP CLI installed on your system. Run the following command to install PHP dependencies.
The `make setup` command will install `localtunnel` and `concurrently` on the system to run WordPress with webhook
functionality.

```shell
composer install
make setup
```

**3. Setup Environment**

Create a `.env` file by copying `.env.example`:

```dotenv
MONDU_TRADE_ENV=dev
MONDU_WEBHOOKS_URL=https://mondu-trade-account-woocommerce-ainsleydev.loca.lt
```

### Running WordPress

The make file exposes a handy `serve` function which runs Wordpress, a local tunnel and tails the WordPress logs. Feel
free to edit this script to suit your needs.

```shell
make serve
```

## Release

To create a new release, follow the following steps:

1. **Bump Version**

- Run the following command to choose the type of release (patch, minor, or major) and update the version
  in `mondu-trade-account.php`. You should merge this into `main` before creating a release.
  ```shell
  make version-bump
  ```

2. **Release**

- Run this command to compare the local version with the remote version and create a new tag if they differ. It will
  then create a new tag which will trigger the pipeline which creates a new zip file on GitHub.
  ```shell
  make release
  ```

These steps will bump the version locally, and then create and push a new release tag to GitHub.

## Copyright

All rights reserved. This plugin and its code are proprietary to ainsley.dev LTD. Unauthorized copying, distribution,
transmission, or storage of this plugin, its code, or content, in whole or in part, in any form or by any means, is
strictly prohibited without prior written permission.

This plugin is licensed for use by end-users on their WordPress sites but may not be copied, shared, modified, or
redistributed in any form, except with explicit written permission from ainsley.dev LTD.

## Licence

Code Copyright 2024 ainsley.dev LTD. Code released under the [GPL-3.0](LICENSE).
