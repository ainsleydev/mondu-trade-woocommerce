<div align="center">
<img width="100" height="25" src="res/logo.svg" alt="Errors Logo"/>
<h3 align="center">Mondu Trade Account - WooCommerce</h3>

![GitHub Release](https://img.shields.io/github/v/release/ainsleydev/mondu-trade-woocommerce?display_name=release&style=flat&cacheSeconds=3600)
[![GNU General Public License 3.0](https://img.shields.io/github/license/ainsleyclark/squidge.svg)](https://www.gnu.org/licenses/gpl-3.0.en.html)
[![WP CS Check](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/lint.yaml/badge.svg?branch=main)](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/lint.yaml)
[![Security](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/security.yaml/badge.svg)](https://github.com/ainsleydev/mondu-trade-woocommerce/actions/workflows/security.yaml)
[![ainsley.dev](https://img.shields.io/badge/-ainsley.dev-black?style=flat&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5wEYDzUGL1b35AAABA1JREFUWMPtlttvFVUUxn977ZnZu+W0tLalqRovBAUvQag0xNQbpSIosSSIJC198YknJfHJxDf9A/DBJ0x8MbFACjVqvCASq6FYFLFBvJAaAomkFCmhHGpLO+PDzOmZzpn2nKP4pCs5ycmevb7vW99as/fA//FfD1XO5p1nzuA3NWJHx5T8cVkRBPHHQfRjd0tzyZhOOQIy27bAxET9zCuvvhY0r2kC/OiRABeAN4BL/4oDr9+3lGszPs7UVNfUE23v3Nj5koszR/8N4EXg3XJckFIFuCLUuU7GWNNtTg25cu4syJx0F+gGMuU4UJKAt1Yux1UKV6TVat1qs+OYwQESMwDQCjwKsOv4iZsnwGihwbiuEek2WjJGhMrvv0UujYKa08VFkQvuTXNgz6oVeCIo1CqrZYMRwTiaytERKn44kRQAsAFYDbBrsLgLRQU0GI919TXKiHQaUQ1GBCuCCQKqjg/MqInrM4lZrgc6A1CljHhRAZ4Ip65m77FaOmbJdehC5vzZr1RAf/T6x6NDwb3/uAVfP74GnwCjZasRuXuWXASj9XQme+3t6erqPcB0IvUuYCsUH8YFBRhRNBqvyYpsn0MeOnG6wvc/9x33MPBjSvp24Na/7cDP7Y/gKIURecZoeTBObkSwWg7UNjaOeFfGLgK9KRAPAM8Wc2FeAUaEWtddbEV2WBFtREXkCqvlghE5yOQkvucBHAR+T0BooAtYXLYDI5sewxWFJ/Kk1bI2UTlW5DMFp03+JPwJ+DQFai2wbiEXUgVUas0trmuslm4jUmGi/tuwDVmrpafBuNPVrs7N/wzQA2QTUJbwYLIlOxB0tOGJ4IhqsSJts+T54Rv0lBz1RFh9ZJA385fOAHAshaMNaAF4OcWFQgeUwhMlrlJdnqjaOLkR8Y2WvbWec9VIQeo4sJf8FZ2LmmgWJO1cmm8I7wc2a6XwosGL+v+rFfnYUYplh47Obo5dvZ8Av6TgbSZ8KxYWEGxZn/u7Dbg9t8HNnwF9S2qqzqVUn4vzQF/K+m3AC1A4jGlId0QC8l0BXKVGrahe//okNR99WZAUc6EXuJiC+zxw57wOxKp/DliRAvCFKDUkxS+YIeBwyvryCHuOC0kH6oBOCj/V/gTeA6aK0oefZj3ARGJdRdh1BQ7Eqm8HHk4B/Q7oB1B9acWFEWtDf5STjGbgqbgLcQcqCQ8NL5EUAPuBsRKqz8UVYB+F97QXcSyatSXoWJ8zvB04AFQlkoaBp4HhhaqPR1TdUsLjeVni8TjhVX0odCAkd4AdKeQAHxIwXEb1Odt+Az5IeVQVcTmhgDBWAhtTNl8G9qGAwKfU2N3SnJvi/RFGMjYCD8UFdACNKRsHgZMA6v0j5ZpAlPtNyvqSiJO/AKik60y0ALlUAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIzLTAxLTI0VDE1OjUzOjA2KzAwOjAwm5vntAAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMy0wMS0yNFQxNTo1MzowNiswMDowMOrGXwgAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII=)](https://ainsley.dev)
[![Twitter](https://img.shields.io/twitter/follow/ainsleydev)](https://twitter.com/ainsleydev)

</div>

## Overview

The Mondu Trade Account - WooCommerce plugin integrates Mondu's Digital Trade Account functionality into your
WooCommerce store, allowing your customers to apply for and manage trade accounts directly during checkout.

- ✅ **Trade Account Applications**: Let customers apply for a trade account while completing their order.
- ✅ **Webhook Integration**: Automatically update customer statuses (e.g., accepted, pending, declined) when a customer
  has applied for a Digital Trade Account.
- ✅ **Custom Styling and Actions**: Easily extend and customize the checkout experience with hooks and filters. Allowing
  you to run actions when a buyer has been accepted or declined.
- ✅ **Admin Management Tools**: Access customer trade account information, logs, and webhook settings from the WordPress
  admin panel.
- ✅ **Secure and Compliant**: Fully supports WooCommerce standards and uses secure connections for API communication.

## Installation

You can either download a the zip file from the releases section or locate it on the WordPress Plugin install page.

## Prerequisites

Before installing and using the Mondu Trade Account - WooCommerce plugin, ensure your environment meets the following
requirements:

- **WordPress**: Requires at least version `6.7`
- **PHP**: Requires at least version `7.4`
- **WooCommerce**: Requires at least version `9.4`
- **Mondu Plugin** Needs to be installed, tested version `3.0.3`

## Backwards Compatibility

This plugin has direct dependency on the `Mondu Plugin`. Before updating both plugins, always test the new version on a
staging environment to ensure compatibility with your customizations, integrations, and WooCommerce setup.

Useful Links:

- [Official GitHub Repository](https://github.com/mondu-ai/bnpl-checkout-woocommerce)
- [Changelog](https://github.com/mondu-ai/bnpl-checkout-woocommerce/blob/main/changelog.txt)

## Buyer States

There are a total of 6 buyer states that a user can be in. If you are admin of the WordPress install, you can change
these states, but it's recommended not to.

| State       | Explanation                                                                                      |
|:------------|:-------------------------------------------------------------------------------------------------|
| `unknown`   | The default status, when no the customer hasn't signed up yet.                                   |
| `applied`   | Customer has tried to apply for a Trade Account, but the webhook hasn't been triggered.          |
| `accepted`  | Customer has been approved a Trade Account and should have a buyer limit.                        |
| `pending`   | Customer is waiting to hear from Mondu if their account has been accepted (Maximum of 48 hours). |
| `declined`  | Customer has been flat-out refused credit from Mondu.                                            |
| `cancelled` | Customer exited out of the Mondu Trade Application form.                                         |

## Sandbox

If you have sandbox mode set on the `Mondu` plugin, you can test the following states with the email addresses listed
below. Note that if an email does not follow this convention, the trade application will fail.

- **`Accepted`**: accepted.good.{random-string}@example.com
- **`Pending`**: pending.pending-brc.{random-string}@example.com
- **`Declined`**: declined.bad.{random-string}@example.com

Note that emails are sent via the Mondu internal inbox in sandbox mode, in order to see them, it's best to reach out to
Mondu.

## Webhooks

Mondu send buyer webhooks when a user has applied for a Trade Account. The following payload will be provided via this
webhook once buyer onboarding requested is processed. See [here](https://docs.mondu.ai/reference/webhooks-overview) for
more details.

If the webhook failed, Mondu will send the webhook in increasing intervals until the `WebhookController` returns an `OK`
response. Mondu will send `6` attempts every minute for all `buyer` and `order` topics until the handler responses with
a OK status code.

**Example Payload**:

```json
{
  "topic": "buyer/{TOPIC_NAME}",
  "buyer": {
    "uuid": "66e8d234-23b5-1125-9592-d7390f20g01c",
    "state": "accepted",
    "external_reference_id": "DE-1-1000745773",
    "company_name": "2023-02-07T15:14:22.301Z",
    "first_name": "John",
    "last_name": "Smith"
  }
}
```

## FAQs

### Is the plugin compatible with the WP block editor?

Not at this time.

### How do I allow for signups outside the checkout?

This plugin adds native support for allowing users to sign up to a Trade Account outside of the checkout. Perfect for
CTA's or banners.

**Note**: The user must be logged in to perform this action, this is because when Mondu responds to the Trade Account
request, a customer ID is required. Before displaying the form below, ensure your users are logged in by using the
WordPress `is_user_logged_in()` function.

The only thing you need to send is a nonce, and the user details will be obtained progromatically from the WP user
that's logged in.

**Shortcode**:

If you don't fancy writing the form yourself, you can easily perform a shortcode as shown below.

```php
echo do_shortcode('[mondu_trade_account_form]');
```

**HTML**:

Alternatively, you can crate the form from scratch as shown below:

```html

<form id="trade-account-signup" method="POST" action="<?php echo admin_url('admin-ajax.php'); ?>">
  <input type="hidden" name="action" value="trade_account_submit">
  <?php wp_nonce_field('trade_account_submit', 'trade_account_submit_nonce'); ?>
  <button type="submit">Submit</button>
</form>
```

**JavaScript**:

Below shows how you can send data to the form via JS.

```js
document.querySelector('form').addEventListener('submit', function (event) {
  event.preventDefault();

  const form = event.target;
  const formData = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    body: formData,
  })
    .then((response) => {
      if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
      }
      return response.json();
    })
    .then((data) => {
      if (!data.error) {
        alert('Trade Account application submitted successfully.');
      } else {
        alert(`Error: ${data.message || 'An error occurred while submitting the application.'}`);
      }
    })
    .catch((error) => {
      alert(`An error occurred: ${error.message}`);
    });
});
```

**Response**:

```json
{
  "status": 200,
  "message": "Trade Account application submitted successfully.",
  "data": {
    "hosted_page_uri": "https://mondu.ai/checkout-page"
  },
  "error": false
}
```

---

### How do I know what the status is of a customer?

Simply go to the user's account on WordPress by navigating to `Users` and click on a customer. From there, you should
see the following fields:

- `uuid` -> The external UUID that's been assigned from Mondu.
- `status` -> The buyer status which can be one of `unknown`, `accepted`, pending` or `declined`.

---

### When will Mondu send emails to the customer?

- After the buyer authorises the onboarding process in hosted checkout page.
- Status change to accepted triggers webhook attempt buyer accepted and the email communication.
- Status change to declined on webhook buyer declined is sent out.

---

### How do I add custom styling to the payment gateway?

There may be times you want to style the checkout gateway with your own styles. To do this, you can either latch onto
the default class name `mondu-trade` or provide your own using a filter.

An example of this is below:

```php
add_filter('mondu_trade_account_checkout_class', function ($class) {
	return $class . ' my-class-name';
});
```

---

### How can I get a buyer status of a user?

You can use the `mondu_trade_get_buyer_status` function to fetch the current status of a customer. This function will
throw a `MonduTradeException` if the provided customer ID is invalid. Ensure to handle exceptions properly when calling
this function.

**Parameters:**

- `$customer_id (int)`: The ID of the customer whose status you want to retrieve.

**Returns**:

- `string`: The current Mondu Trade Account status of the customer, see above for possible values.

**Throws**:

- `MonduTradeException`: If the customer ID is not valid.

**Example**:

Here’s an example of how to call the `mondu_trade_get_buyer_status` function and handle possible exceptions:

```php
try {
    $customer_id = 123; // Replace with the actual customer ID
    $status = mondu_trade_get_buyer_status($customer_id);

    echo "Customer Status: " . $status;
} catch (MonduTradeException $e) {
    echo "Error: " . $e->getMessage();
}
```

---

### How can I get a buyer limit of a user?

You can use the `mondu_trade_get_buyer_limit` function to fetch the buyer limit for a customer. This function will
throw a `MonduTradeException` if the provided customer ID is invalid or if the buyer status is not `accepted`. Ensure to
handle exceptions properly when calling this function.

**Parameters:**

- `$customer_id (int)`: The ID of the customer whose buyer limit you want to retrieve.

**Returns**:

- `array`: An associative array containing the buyer limit details (see sample below).

**Throws**:

- `MonduTradeException`: If the customer ID is not valid or the buyer status is not `accepted`.

**Example**:

Here’s an example of how to call the `mondu_trade_get_buyer_limit` function and handle possible exceptions:

```php
try {
    $customer_id = 123; // Replace with the actual customer ID
    $buyer_limit = mondu_trade_get_buyer_limit($customer_id);

    print_r($buyer_limit);
} catch (MonduTradeException $e) {
    echo "Error: " . $e->getMessage();
}
````

**Sample Output**:

```php
Array (
    [purchasing_limit] => Array (
        [purchasing_limit_cents] => 100000
        [balance_cents] => 10000
        [max_purchase_value_cents] => 90000
        [max_collections_state] => no
    )
)
```

---

### How can I run actions when a buyer status has changed?

There are 4 different actions you can latch onto when Mondu replies with an update after a customer has applied for a
Digital Trade Account. Below is a list of available actions.

**Example Payload**

Below is an example of a buyer and topic sent via the actions, see
the [Mondu Webhooks Overview](https://docs.mondu.ai/reference/webhooks-overview) for more information

```json
{
  "topic": "buyer/{TOPIC_NAME}",
  "buyer": {
    "uuid": "66e8d234-23b5-1125-9592-d7390f20g01c",
    "state": "accepted",
    "external_reference_id": "DE-1-1000745773",
    "company_name": "2023-02-07T15:14:22.301Z",
    "first_name": "John",
    "last_name": "Smith"
  }
}
```

### General Webhook Action

`mondu_trade_buyer_webhook_received`

Triggered when a webhook related to a buyer is received from Mondu.

**Parameters:**

- `$state (string)`:    The current state of the buyer (e.g. `accepted`, `pending`, `declined`).
- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

**Example**:

```php
/**
 * Handles general webhook actions when a buyer webhook is received from Mondu.
 *
 * @param string $state       The current state of the buyer (e.g., accepted, pending, declined).
 * @param int    $customer_id The WooCommerce customer ID.
 * @param array  $buyer       The buyer object containing buyer details.
 * @return void
 */
function handle_mondu_trade_buyer_webhook($state, $customer_id, $buyer) {
    print_r([
        'state' => $state,
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
}

add_action('mondu_trade_buyer_webhook_received', 'handle_mondu_trade_buyer_webhook', 10, 3);
```

### Accepted

`mondu_trade_buyer_accepted`

Triggered when a buyer has been accepted for a Trade Account.

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

**Example**:

```php
/**
 * Handles the "accepted" webhook when a buyer is approved for a Trade Account.
 *
 * @param int   $customer_id The WooCommerce customer ID.
 * @param array $buyer       The buyer object containing buyer details.
 * @return void
 */
function handle_mondu_trade_buyer_accepted($customer_id, $buyer) {
    print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);

    // You can now retrieve the buyer limit by using the
    // mondu_trade_get_buyer_limit($customer_id) function.
}

add_action('mondu_trade_buyer_accepted', 'handle_mondu_trade_buyer_accepted', 10, 2);
```

### Pending

`mondu_trade_buyer_pending`

Triggered when a buyer is in a pending state (maximum 48 hours).

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

**Example**:

```php
/**
 * Handles the "pending" webhook when a buyer is in a pending state.
 *
 * @param int   $customer_id The WooCommerce customer ID.
 * @param array $buyer       The buyer object containing buyer details.
 * @return void
 */
function handle_mondu_trade_buyer_pending($customer_id, $buyer) {
    print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
}

add_action('mondu_trade_buyer_pending', 'handle_mondu_trade_buyer_pending', 10, 2);
```

### Declined

`mondu_trade_buyer_declined`

Triggered when a buyer has been declined for a Trade Account.

**Parameters:**

- `$customer_id (int)`: The WooCommerce customer ID.
- `$buyer (array)`:     The buyer object, see above for an example.

**Example**:

```php
/**
 * Handles the "declined" webhook when a buyer is declined for a Trade Account.
 *
 * @param int   $customer_id The WooCommerce customer ID.
 * @param array $buyer       The buyer object containing buyer details.
 * @return void
 */
function handle_mondu_trade_buyer_declined($customer_id, $buyer) {
    print_r([
        'customer_id' => $customer_id,
        'buyer' => $buyer,
    ]);
}

add_action('mondu_trade_buyer_declined', 'handle_mondu_trade_buyer_declined', 10, 2);
```

---

### How can I email a customer after their status has changed?

In some circumstances, Mondu don't send emails to customers to update them. If you would like to send emails from
WooCommerce, you can latch onto the `mondu_trade_buyer_webhook_received` webhook and use the `WC` mailer instance.

An example of how you might do this is below.

```php
/**
 * Sends an email to the customer when their status changes.
 *
 * @param string $state The buyer state, e.g., "accepted", "pending", or "declined".
 * @param int $customer_id The WooCommerce customer ID.
 * @param array $buyer The buyer object containing buyer details.
 */
function send_email_on_status_change($state, $customer_id, $buyer) {
    // Retrieve customer data.
    $customer = new WC_Customer($customer_id);
    $email = $customer->get_email();

    // Set email subject and email heading.
    $subject = sprintf(__('Your Trade Account Status: %s', 'mondu-trade-account'), ucfirst($state));
    $email_heading = __('Trade Account Status Update', 'mondu-trade-account');

    // Prepare email content.
    ob_start();
    ?>

    <!-- Intro -->
    <p><?php printf(__('Dear %s,', 'mondu-trade-account'), esc_html($customer->get_first_name())); ?></p>
    <p><?php _e('We would like to update you on the current status of your Mondu Digital Trade Account:', 'mondu-trade-account'); ?></p>
    <p><strong><?php printf(__('Status: %s', 'mondu-trade-account'), ucfirst(esc_html($state))); ?></strong></p>

    <!-- Status -->
    <?php if ($state === 'accepted') : ?>
        <p><?php _e('Congratulations! Your trade account has been approved. You can now enjoy extended purchasing limits and flexible payment terms.', 'mondu-trade-account'); ?></p>
    <?php elseif ($state === 'pending') : ?>
        <p><?php _e('Your application is under review. We will notify you once a decision has been made.', 'mondu-trade-account'); ?></p>
    <?php elseif ($state === 'declined') : ?>
        <p><?php _e('Unfortunately, your trade account application was not approved. Feel free to reach out to our support team for assistance.', 'mondu-trade-account'); ?></p>
    <?php endif; ?>

    <!-- Footer -->
    <p><?php _e('Thank you for choosing us!', 'mondu-trade-account'); ?></p>

    <?php
    $email_body = ob_get_clean();

    // Use WooCommerce mailer.
    $mailer = WC()->mailer();
    $email_content = $mailer->wrap_message($email_heading, $email_body);

    // Send the email.
    $mailer->send($email, $subject, $email_content);
}

add_action('mondu_trade_buyer_webhook_received', 'send_email_on_status_change', 10, 3);
```

## Development

Below are the steps to install the plugin on your local machine for development.

### Setup

To get setup with plugin, follow the steps listed below.

**1. Clone the Repository**

Clone the repository into your `/wp-content/plugins` folder.

```shell
git clone https://github.com/ainsleydev/mondu-trade-woocommerce
cd mondu-trade-woocommerce
```

**2. Install Dependencies**

Ensure you have Composer and the WP CLI installed on your system. Run the following command to install PHP dependencies.
The `make setup` command will install `localtunnel` and `concurrently` on the system to run WordPress with webhook
functionality.

```shell
composer install
make setup
```

**3. Setup Environment**

Create a `.env` file by copying `.env.example`:

```dotenv
MONDU_TRADE_ENV=dev
MONDU_WEBHOOKS_URL=https://mondu-trade-account-woocommerce-ainsleydev.loca.lt
```

### Running WordPress

The make file exposes a handy `serve` function which runs Wordpress, a local tunnel and tails the WordPress logs. Feel
free to edit this script to suit your needs.

```shell
make serve
```

## Release

To create a new release, follow the following steps:

1. **Bump Version**

- Run the following command to choose the type of release (patch, minor, or major) and update the version
  in `mondu-trade-account.php`. You should merge this into `main` before creating a release.

  ```shell
  make version-bump
  ```

2. **Release**

- Run this command to compare the local version with the remote version and create a new tag if they differ. It will
  then create a new tag which will trigger the pipeline which creates a new zip file on GitHub.

  ```shell
  make release
  ```

These steps will bump the version locally, and then create and push a new release tag to GitHub.

## Copyright

All rights reserved. This plugin and its code are proprietary to ainsley.dev LTD. Unauthorized copying, distribution,
transmission, or storage of this plugin, its code, or content, in whole or in part, in any form or by any means, is
strictly prohibited without prior written permission.

This plugin is licensed for use by end-users on their WordPress sites but may not be copied, shared, modified, or
redistributed in any form, except with explicit written permission from ainsley.dev LTD.

## Licence

Code Copyright 2024 ainsley.dev LTD. Code released under the [GPL-3.0](LICENSE).
